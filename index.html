<!DOCTYPE HTML>
<html>
	<head>
		<link rel="stylesheet" href="css/style.css">

		<script src="js/util.js"></script>


	</head>
	
	<body>


		<div id="audioplayer" style="position: fixed; background-color: white;width:100%;margin-top: -8px; padding-bottom: 40px; padding-left: 40px;border: 1px solid black;">

			<h1> PLAYER </h1>


			
			<div style="display: block; "><small id="track-name"><strong>track name:</strong> <div style="display: inline;" id="trackName"> </div>  </small></div>
			<div id="timeline">
				<div id="playhead"></div>
			</div>
		

			<audio id="player" > Your browser does not support HTML5 audio. </audio>
			
			<div id="controls" class="controls">

				<div id="div_play"> <button id="btn_play">Play</button> </div>
				<div id="div_pause" style="display:none;"> <button id="btn_pause">Pause</button> </div>
				<div id="div_stop" style="display:none;"> <button id="btn_stop">Stop</button> </div>
				
				<button id="btn_prev">Prev</button> 

				<button id="btn_next">Next</button> 

			</div>

		</div>


		<div id="list"></div>

		

		<script>
			// Mock list
			/*sources = [
				{
					'url':'mp3/AC_DC/Back In Black (Disc 8)/06 - Back In Black.mp3',
					'trackName':'Back In Black',
					'artist':'AC_DC'
				},
				
				{
					'url':'mp3/AC_DC/Back In Black (Disc 8)/01 - Hells Bells.mp3',
					'trackName':'Hells Bells',
					'artist':'AC_DC'
				}
			];*/

			
			//GLOBALS
			audio = document.querySelector('#player');
			isPlaying = false;
			index = 0;
			currentTrack = undefined

			loadJSON('/list.json',function(response){
				//console.log(JSON.stringify(response));
				
				// Getting music list
				sources = JSON.parse(response);

				//generating play list from 'sources'
				genList(sources,"artist")
				for( artist in sources ) {
					for( album in sources[artist]) {
						for(trackIndex in sources[artist][album]){
							track = sources[artist][album][trackIndex]
							if( currentTrack == undefined ){
								currentTrack = track
								console.log("FIRST TRACK: " + JSON.stringify(currentTrack))
							}							
							//console.log(track.trackName)
						}
					}
					
				}

				//initialize by the first music
				audio.src = currentTrack.url;
				document.querySelector("#trackName").innerHTML = currentTrack.trackName

				// Doing 'auto next' when the music is finished
				audio.addEventListener('ended',function(){
					/*lastIndex = sources.length;
      				index = index + 1;
      				audio.src=track.url;
      				play(track);*/
      				next()
    			},false);

				// BUTTONS EVENTS

				document.querySelector('#btn_play').addEventListener('click',function(){
					play(currentTrack);
				});

				document.querySelector('#btn_pause').addEventListener('click',function(){
					pause();
				});

				document.querySelector('#btn_stop').addEventListener('click',function(){
					stop();
				});


				document.querySelector('#btn_next').addEventListener('click',function(){
					next();
				});

				document.querySelector('#btn_prev').addEventListener('click',function(){
					prev();
				});				


				

				// Treating 'play' event
				audio.addEventListener('play',function(){
					document.querySelector('#div_play').style.display="none";
					document.querySelector('#div_pause').style.display="inline-block";
					document.querySelector('#div_stop').style.display="inline-block";	
				},false);

				// Treating 'pause/stop' event
				audio.addEventListener('pause',function(){
					document.querySelector('#div_play').style.display="inline-block";
					document.querySelector('#div_pause').style.display="none";
					document.querySelector('#div_stop').style.display="none";	
				},false);				

				var duration;
				audio.addEventListener('timeupdate',function() {
					if( duration != undefined && duration != null && duration > 0){
						var playPercent = 100 * (audio.currentTime / duration);
						playhead.style.marginLeft = playPercent + "%";
					}
				}, false);

				// Gets audio file duration
				audio.addEventListener("canplaythrough", function () {
					duration = audio.duration;
				}, false);

				timeline.addEventListener('mousedown',function(e) {
					pause()
					console.log("seekbar clicked")
					var x = e.pageX - e.currentTarget.offsetLeft; 
    				var y = e.pageY - e.currentTarget.offsetTop;
    				console.log("x: " + x);
    				console.log("y: " + y); 
    				bRect = timeline.getBoundingClientRect();
    				console.log("SIZE: " + bRect.width);
    				barPercentOnClick = 100 * ( x / bRect.width );
    				if(barPercentOnClick < 5) {
    					barPercentOnClick = 5;
    				}
    				console.log("barPercentOnClick: " + barPercentOnClick)
    				console.log("DURATION: " + duration);

    				
    				currentTime = (duration * barPercentOnClick) / 100
     				if( currentTime > duration ){
    					currentTime = duration
    				}
    				console.log("Current time: " + currentTime)
    				var playPercent = 100 * (currentTime / duration);
    				
					playhead.style.marginLeft = ( playPercent ) + "%";

					audio.currentTime = currentTime;


				})

				timeline.addEventListener('mousedown',function(e) {
					play()
				})


			})

			/*start the 'audio' player
				Arguments:
					index: (int) track index inside 'sources' array

			*/
			function play(track,changeSrc=false){
				if(track == undefined){
					track = currentTrack
				}

				//change source url only if needed. In this case, when some track from list is clicked.
				if(changeSrc) {
					audio.src = track.url;					
				}
				trackName = document.querySelector('#trackName');
				if(trackName != undefined){
					trackName.innerHTML=track.trackName;
				}
				console.log("Playing...: " + track.trackName);
				audio.play();
				isPlaying = true;
			}

			function playAndMark(base64EncodedString){
				stop()
				decodedString = Base64.decode(base64EncodedString)
				List = decodedString.split(/\|/)
				url = List[0]
				artist = List[1]
				album = List[2]
				trackName = List[3]

				for( index in sources[artist][album]){
					track = sources[artist][album][index]
					if(track.trackName == trackName) {
						currentTrack = track
						play(track,true)
					}
				}
			}

			/*stop the audio player
				Arguments: no arguments
					

			*/
			function stop(){
				isPlaying = false;
				audio.pause();
				audio.currentTime = 0;
			}

			/*pause the audio player
				Arguments: no arguments
					

			*/
			function pause(){
				isPlaying = false;
				console.log("Pausing " + index + " ...:")
				audio.pause();
			}

			/*change to the previous track on playlist controled by 'index' variable. If 
			music is the first track, previous will be the last music and so on.
				Arguments: no arguments
					

			*/
			function prev() {
				index -= 1;
				if(index < 0 ){
					index = sources.length - 1;
				}

				audio.src=sources[index].url
				play(index)
			}

			/*change to the next track on playlist controled by 'index' variable. If 
			music is the last track, next will be the first music and so on.
				Arguments: no arguments
					

			*/
			function next() {
				//calculating next track
				artist = currentTrack.artist
				album = currentTrack.album
				trackName = currentTrack.trackName
				//finding current track on album list
				
				for(trackIndex in sources[artist][album]){
					trackIndex = parseInt(trackIndex)
					track = sources[artist][album][trackIndex]
					if( track.trackName == trackName ){
						len = sources[artist][album].length
						if(trackIndex + 1 < len){
							console.log("CURRENT TRACK INDEX: " + trackIndex)
							console.log("current TRACK" + JSON.stringify(sources[artist][album][trackIndex]) )
							trackIndex = trackIndex + 1;
							console.log("NEXT TRACK INDEX: " + trackIndex)
							nextTrack = sources[artist][album][trackIndex]
							console.log("NEXT TRACK: " + JSON.stringify(nextTrack))
							currentTrack = nextTrack
							play(nextTrack,true)
							return true
						}
					}							
					//console.log(track.trackName)
				}
				
				return true
			}			






			/*Generates a track's list based on JSON with metadata of the tracks. This file is generated by 'link_creator.pl' script.

			*/
			function genList(sources,type) {
				if( type == undefined ) {
					type = "artist"
				}
				list = document.querySelector("#list")

				switch(type) {

					case "artist": 
						
						listStr = "<ul>"
						fakeIndex = 1;
						for( artist in sources ){
							listStr += "<li>" + artist + "<ul>"
							for(album in sources[artist] ){
								listStr += "<li>" + album + "<ul>"
								for(trackIndex in sources[artist][album]){
									track = sources[artist][album][trackIndex]
									encodedData = Base64.encode(track.url + "|" + track.artist + "|" + track.album + "|" + track.trackName)
									listStr += "<li> <a href='javascript:null' id=" + fakeIndex + " onclick=\"playAndMark(\'" + encodedData + "\')\" >" + track.trackName + "</a></li>"

								}
								listStr += "</ul>"

								listStr += "</li>"
							}
							listStr += "</ul>"
							/*console.log("Playing index - " + i);
							source = sources[i]
							listStr += "<tr><td>" + fakeIndex + ". </td><td><a href='javascript:null' id=" + i + " onclick='play(" + i + ",true)' >" + source['trackName'] + "</a></td><td>" + source['artist'] + "</td><td>" + source['album'] + "</td></tr>"*/
							listStr += "</li>"
							fakeIndex += 1;
						}
						listStr += "</ul>"
						break;
					case "album": break;
					default: console.log("Invalid option to generate music list!")
				}
				
				//console.log(listStr)
				list.innerHTML = listStr;
			}

		</script>
		</div>
	</body>
</html>